#: import GLShaderLexer pygments.lexers.GLShaderLexer

# -----------------------
# MAIN DISPLAY
# -----------------------
<MainDisplay>:
    id: main_display
    tab_pos: 'top_mid'
    tab_width: (self.size[0] / 5) - 1
    # do_default_tab: False
    default_tab: image_tab

    canvas:
        Color:
            rgba: (.188, .188, .188, 1)
        Rectangle:
            size: self.size
            pos: self.pos

    TabbedPanelItem:
        id: config_tab
        text: 'Configuration'
        ConfigTab:

    TabbedPanelItem:
        id: image_tab
        text: 'Live Image'
        ImageTab:

    TabbedPanelItem:
        id: motion_tab
        text: 'Motion'
        MotionTab:

    TabbedPanelItem:
        id: protocol_tab
        text: 'Protocol'
        ProtocolTab:

    TabbedPanelItem:
        id: analysis_tab
        text: 'Analysis'
        AnalysisTab:

# --------------------------------------------
# Microscope Configuration Layout
# --------------------------------------------
<ConfigTab>:
    orientation: 'vertical'
    Label:
        text: 'Microscope Configfuration'

# --------------------------------------------
# Image Settings and Adjustment Layout
# --------------------------------------------
<ImageTab>:
    BoxLayout:
        orientation: 'horizontal'
        # ShaderEditor:
        #     viewer: viewer_id
        #     size_hint_x: 0.2

        ShaderViewer:
            id: viewer_id
            size_hint_x: 0.8

    ShaderSettings:
        id: shadersettings_id
        size_hint: None, None
        size: 300, root.height
        pos: root.width-300, 0
    # Camera Controls
    # ------------------------------
    BoxLayout:
        orientation: 'horizontal'
        padding: 5
        spacing: 5
        size_hint: None, None
        size: 200, 40
        pos: root.width/2-100, 0
        ToggleButton:
            id: play_btn
            width: 100
            text: 'Pause'
            state: 'down'
            on_press: root.cam_toggle()
        Button:
            id: capture_btn
            width: 100
            text: 'Capture'
            on_press: root.capture()
        # Slider:
        #     id: zoom_slider
        #     width: 100

# ShaderEditor - view and edit shader code
# ------------------------------------------
<ShaderEditor>:
    orientation: 'vertical'
    # Fragment Shader Editor
    Label:
        text: 'Fragment Shader'
        size_hint_y: None
        height: self.texture_size[1] + 10
    CodeInput:
        text: root.fs
        lexer: GLShaderLexer()
        on_text: root.fs = args[1]

    # Vertex Shader Editor
    Label:
        text: 'Vertex Shader'
        size_hint_y: None
        height: self.texture_size[1] + 10
    CodeInput:
        text: root.vs
        lexer: GLShaderLexer()
        on_text: root.vs = args[1]

# ShaderViewer - Shaded Live Camera view
# ------------------------------------------
<ShaderViewer>:
    PylonCamera:
        id: microscope_camera

    # Camera:
    #     id: microscope_camera
    #     play: True
    #     index: 0
    #     resolution: (1920, 1080)
    #     allow_stretch: True
    #     keep_ratio: True
    #
    # Image:
    #     id: microscope_camera
    #     source: './data/composite.tif'
    #     allow_stretch: True
    #     keep_ratio: True


# ShaderSettings - Widgets to control Shader Settings
<ShaderSettings>:
    orientation: 'vertical'
    spacing: 5
    padding: 5
    canvas:
        Color:
            rgba: 0, 0, 0, 0.2
        Rectangle:
            size: self.size
            pos: self.pos

    # -----------------------
    # BRIGHTFIELD Settings
    # -----------------------
    LED_Control:
        id: bf_led_id
        ctrl_label: 'Brightfield'
        size_hint: 1, 0.25
        bg_color: 0.5, 0.5, 0.5, 1

    # BLUE lED Settings
    LED_Control:
        id: bl_led_id
        ctrl_label: 'Blue LED'
        size_hint: 1, 0.25
        bg_color: 0, .5, 1, 1

    # GREEN lED Settings
    LED_Control:
        id: gr_led_id
        ctrl_label: 'Green LED'
        size_hint: 1, 0.25
        bg_color: .2, 0.8, 0.2, 1

    # RED lED Settings
    LED_Control:
        id: rd_led_id
        ctrl_label: 'Red LED'
        size_hint: 1, 0.25
        bg_color: 1, 0.2, 0, 1

<LED_Control>:
    padding: 5
    spacing: 5
    orientation: 'vertical'
    canvas:
        Color:
            rgba: 0, 0, 0, 0.5
        Rectangle:
            size: self.size
            pos: self.pos

    # BoxLayout:
    #     Label:
    #         text: root.ctrl_label
    #         text_size: self.size
    #         halign: 'center'
    #         valign: 'middle'
    #     Switch:
    #         active: True

    # Illumination
    BoxLayout:

        orientation: 'vertical'
        spacing: 10

        Label:
            text: root.ctrl_label
            halign: 'center'
            valign: 'middle'

        BoxLayout:
            orientation: 'horizontal'
            Label:
                text: 'Illumination'
                halign: 'center'
                valign: 'middle'

            TextInput:
                size_hint_x: None
                width: 50
                multiline: False
                font_size: 14
                padding: [10, (self.height-self.line_height)/2]
                halign: 'left'
                background_color: 0.6, 0.6, 0.6, 1
                input_filter: 'float'
                text:"%.2f" % illumination_id.value

            Slider:
                id: illumination_id
                min: 0
                max: 1.
                value: 0
                cursor_size: 20,20
                cursor_image: './data/slider_cursor.png'
                value_track: True
                value_track_color: root.bg_color
                on_value: root.parent.get_sliders()

        # Gain
        BoxLayout:
            orientation: 'horizontal'
            Label:
                text: 'Gain'
                halign: 'center'
                valign: 'middle'
                padding: 5, 5
            TextInput:
                size_hint_x: None
                width: 50
                multiline: False
                font_size: 14
                padding: [10, (self.height-self.line_height)/2]
                halign: 'left'
                background_color: 0.6, 0.6, 0.6, 1
                input_filter: 'float'
                text:"%.2f" % gain_id.value
                spacing: 15, 15
            Slider:
                id: gain_id
                min: 0
                max: 2.
                value: 1.
                cursor_size: 20,20
                cursor_image: './data/slider_cursor.png'
                value_track: True
                value_track_color: root.bg_color
                on_value: root.parent.get_sliders()

        # Exposure
        BoxLayout:
            orientation: 'horizontal'
            Label:
                text: 'Exposure'
                halign: 'center'
                valign: 'middle'
                padding: 5, 5
            TextInput:
                size_hint_x: None
                width: 50
                multiline: False
                font_size: 14
                padding: [10, (self.height-self.line_height)/2]
                halign: 'left'
                background_color: 0.6, 0.6, 0.6, 1
                input_filter: 'float'
                text: str(int(exposure_id.value))
            Slider:
                id: exposure_id
                min: 100
                max: 200
                value: 150
                cursor_size: 20,20
                cursor_image: './data/slider_cursor.png'
                value_track: True
                value_track_color: root.bg_color
                on_value: root.parent.get_sliders()

# --------------------------------------------
# Microscope Motion Layout
# --------------------------------------------
<MotionTab>:
    Label:
        text: 'Control microscope motion'

# --------------------------------------------
# Protocol Layout
# --------------------------------------------
<ProtocolTab>:
    orientation: 'vertical'
    padding: 5
    spacing: 5
    # row_default_height: 40

    BoxLayout:

    GridLayout:
        cols: 3
        spacing: 5
        size_hint_y: None
        height: 80
        Label:
            text: 'Capture Period'
        TextInput:
            id: capture_period
            multiline: False
            padding: [10, (self.height-self.line_height)/2]
            halign: 'right'
            input_filter: 'float'
            text: '5'
        Label:
            text: 'minutes'

        Label:
            text: 'Capture Duration'
        TextInput:
            id: capture_dur
            multiline: False
            padding: [10, (self.height-self.line_height)/2]
            halign: 'right'
            input_filter: 'float'
            text: '48'
        Label:
            text: 'hours'

    BoxLayout:
        spacing: 5
        size_hint_y: None
        height: 20

    BoxLayout:
        spacing: 5
        size_hint_y: None
        height: 40
        orientation: 'horizontal'
        # PROTOCOL - LABELS
        Label:
            text: ''
            size_hint_x: None
            width: 100
        Label:
            text: 'Folder'
        Label:
            text: 'Filename Root'
        Label:
            text: 'Ill.'
            size_hint_x: None
            width: 40
        Label:
            text: 'Gain'
            size_hint_x: None
            width: 40
        Label:
            text: 'Exp.'
            size_hint_x: None
            width: 50
        Label:
            text: 'Acq.'
            size_hint_x: None
            width: 40

    Protocol_Control:
        id: bf_protocol
        protocol_label: 'Brightfield'
        save_folder: '.\\'
        file_root: 'bright_'
        bg_color: 1, 1, 1, 0.2
    Protocol_Control:
        id: bl_protocol
        protocol_label: 'Blue'
        save_folder: '.\\'
        file_root: 'blue_'
        bg_color: 0, 0.2, 1, 0.2
    Protocol_Control:
        id: gr_protocol
        protocol_label: 'Green'
        save_folder: '.\\'
        file_root: 'green_'
        bg_color: 0.2, 1, 0.2, 0.2
    Protocol_Control:
        id: rd_protocol
        protocol_label: 'Red'
        save_folder: '.\\'
        file_root: 'red_'
        bg_color: 1, 0.2, 0, 0.2
    Protocol_Control:
        id: composite_protocol
        protocol_label: 'Composite'
        save_folder: '.\\'
        file_root: 'composite_'
        bg_color: 1, 1, 1, 0.2

    BoxLayout:

    BoxLayout:
        spacing: 5
        size_hint_y: None
        height: 40
        orientation: 'horizontal'
        # PROTOCOL - LABELS
        Button:
            text: 'Import from Live Image'
            on_press: root.import_vals()
        Button:
            text: 'Load Protocol'
            on_press: root.load_protocol()
        Button:
            text: 'Save Protocol'
            on_press: root.save_protocol()
        ToggleButton:
            id: run_btn
            text: 'Run Protocol'
            state: 'normal'
            on_press: root.run_protocol()


<Protocol_Control>:
    spacing: 5
    size_hint_y: None
    height: 40
    Label:
        size_hint_x: None
        width: 100
        canvas:
            Color:
                rgba: root.bg_color
            Rectangle:
                size: self.size
                pos: self.pos
        text: root.protocol_label
    Button:
        id: save_folder_id
        text: str(root.save_folder)
        on_press: root.choose_folder()
    TextInput:
        id: file_root_id
        text: str(root.file_root)
        multiline: False
        padding: [10, (self.height-self.line_height)/2]
    TextInput:
        id: ill_val
        size_hint_x: None
        width: 40
        multiline: False
        padding: [10, (self.height-self.line_height)/2]
    TextInput:
        id: gain_val
        size_hint_x: None
        width: 40
        multiline: False
        padding: [10, (self.height-self.line_height)/2]
    TextInput:
        id: exp_val
        size_hint_x: None
        width: 50
        multiline: False
        padding: [10, (self.height-self.line_height)/2]
    CheckBox:
        id: acquire
        size_hint_x: None
        width: 40
        active: False

<LoadDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: '.\\'
        BoxLayout:
            size_hint_y: None
            height: 40
            Button:
                text: "Cancel"
                on_release: root.cancel()
            Button:
                text: "Select"
                on_release: root.load(filechooser.path)

# --------------------------------------------
# Analysis Layout
# --------------------------------------------
<AnalysisTab>:
    Label:
        text: 'Perform image stack analysis'
